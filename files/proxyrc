########## Proxy profiles ##########

# 检测 WSL，并拿到 Windows host IP（给 WSL -> Win Clash 用）
# 逻辑：
# - 如果是在 WSL：从 /etc/resolv.conf 里拿 nameserver，当成 Win host IP
# - 如果失败，就退回 127.0.0.1
# 检测 WSL，并拿到 Windows host IP（给 WSL -> Win Clash 用）
if grep -qi microsoft /proc/version 2>/dev/null; then
    # 1. 优先用默认网关（WSL 里看到的 Win host IP）
    WSL_HOST_IP=$(ip route | awk '/^default/ {print $3; exit}')

    # 2. 如果没拿到，再退回到 resolv.conf（少数极端情况）
    if [ -z "$WSL_HOST_IP" ]; then
        WSL_HOST_IP=$(grep -m1 nameserver /etc/resolv.conf 2>/dev/null | awk '{print $2}')
    fi

    [ -z "$WSL_HOST_IP" ] && WSL_HOST_IP="127.0.0.1"
fi


# 1) 自己搭的“跳板机”出口
PROXY_URL_jump="http://43.129.192.176:8888"

# 2) Clash 出口
#    - 在纯 Linux 上：一般就是 127.0.0.1:7890
#    - 在 WSL 里：希望走 Win host 的 Clash，就用上面探测到的 WSL_HOST_IP
#    这里做一个小逻辑：如果检测到了 WSL_HOST_IP，就默认走 Win；否则走本机 127.0.0.1
if [ -n "$WSL_HOST_IP" ]; then
    PROXY_URL_clash="http://$WSL_HOST_IP:7890"
else
    PROXY_URL_clash="http://127.0.0.1:7890"
fi
# 端口如果你 Clash 改过，改这里就可以了


# 当前模式：默认关闭
export PROXY_MODE="off"


# 核心函数：切换到某个 profile
proxy_use() {
    local name="$1"

    # off 或未传参数 -> 关闭
    if [ -z "$name" ] || [ "$name" = "off" ]; then
        unset http_proxy https_proxy all_proxy
        export PROXY_MODE="off"
        echo "Proxy OFF"
        return 0
    fi

    # 根据 name 取对应的 PROXY_URL_xxx 变量
    local var="PROXY_URL_${name}"
    local url="${!var}"

    if [ -z "$url" ]; then
        echo "Unknown proxy profile: $name"
        echo "Use: proxy_list  查看可用 profile"
        return 1
    fi

    export http_proxy="$url"
    export https_proxy="$url"
    export all_proxy="$url"
    export no_proxy="localhost,127.0.0.1,::1"
    export PROXY_MODE="$name"

    echo "Proxy ON: $name -> $url"
}

# 查看当前有哪些 profile
proxy_list() {
    echo "Available proxy profiles:"
    for name in jump clash; do
        local var="PROXY_URL_${name}"
        local url="${!var}"
        [ -n "$url" ] && printf "  %-6s %s\n" "$name" "$url"
    done
    echo "Current: ${PROXY_MODE:-off}"
}

# 一键轮换：off -> jump -> clash -> off ...
proxy_toggle() {
    case "$PROXY_MODE" in
        off|"")
            proxy_use jump   ;;
        jump)
            proxy_use clash  ;;
        clash)
            proxy_use off    ;;
        *)
            proxy_use off    ;;
    esac
}

