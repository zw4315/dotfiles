#!/bin/bash
set -euo pipefail

# 1. æ£€æµ‹ dotfiles ç›®å½•
DOTFILES="${DOTFILES:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
echo "Installing dotfiles from: $DOTFILES"

# 2. é“¾æ¥ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•ï¼ˆå®‰å…¨æ¨¡å¼ï¼šä¸è¦†ç›–å·²æœ‰éè½¯é“¾ï¼‰
link_one() {
    local src="$1"
    local dst="$2"

    # å¦‚æœå·²ç»æ˜¯æ­£ç¡®çš„è½¯é“¾ï¼Œè·³è¿‡
    if [[ -L "$dst" && "$(readlink "$dst")" == "$src" ]]; then
        echo "âœ… $dst already linked"
        return
    fi

    # å¦‚æœç›®æ ‡å­˜åœ¨ä¸”ä¸æ˜¯è½¯é“¾ï¼Œå¤‡ä»½
    if [[ -e "$dst" && ! -L "$dst" ]]; then
        mv "$dst" "$dst.backup.$(date +%s)"
        echo "ğŸ’¾ Backup $dst"
    fi

    ln -sfn "$src" "$dst"
    echo "ğŸ”— Linked $dst â†’ $src"
}

# 3. é“¾æ¥æ‰€æœ‰ dotfilesï¼ˆä¿æŒç»“æ„ï¼‰
link_all() {
    for path in "$DOTFILES/files"/*; do
        local name
        name="$(basename "$path")"

        if [[ "$name" == "vim" ]]; then
            # Vim ç‰¹æ®Šå¤„ç†ï¼Œä¿ç•™ ~/.vim/plugin
            link_vim_preserve_plugins "$path" "$HOME/.vim"
        else
            link_one "$path" "$HOME/.$name"
        fi
    done
}

# 4. ä¿ç•™ ~/.vim/pluginï¼Œåªè½¯é“¾å…¶ä»–å†…å®¹
link_vim_preserve_plugins() {
    local src_root="$1"
    local dst_root="$2"

    mkdir -p "$dst_root"

    for sub in "$src_root"/*; do
        local base
        base="$(basename "$sub")"

        if [[ "$base" == "plugin" ]]; then
            # è·³è¿‡ plugin ç›®å½•ï¼Œä¸è¦†ç›–ç°æœ‰æ’ä»¶
            echo "âš ï¸ Skipping linking of $dst_root/plugin to preserve existing plugins"
            continue
        fi

        link_one "$sub" "$dst_root/$base"
    done
}

# 5. æ‰§è¡Œ
sudo apt install ripgrep
sudo apt install universal-ctags
sudo apt install global cscope
sudo apt install python3-pygments
link_all
echo "âœ… All dotfiles linked."

