#!/bin/bash

set -euo pipefail

# 1. Environment setup
DOTFILES="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export DOTFILES

# 2. Load utilities
if [[ -f "$DOTFILES/lib/utils.sh" ]]; then
    source "$DOTFILES/lib/utils.sh"
else
    echo "Error: lib/utils.sh not found."
    exit 1
fi

# 3. Load configuration
# Allow user to provide a custom config file
CONFIG_FILE="${1:-$DOTFILES/config.sh}"
if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
else
    log_warn "Config file not found: $CONFIG_FILE. Running all modules by default."
    MODULES=(links apt tools)
fi

# 4. Run modules
for module in "${MODULES[@]}"; do
    module_file="$DOTFILES/modules/$module.sh"
    if [[ -f "$module_file" ]]; then
        log_info "--- Running module: $module ---"
        # Source the module in a subshell or clear run_module function to avoid conflicts
        # Using a function wrap in the module file is cleaner
        (
            source "$module_file"
            if command -v run_module >/dev/null; then
                run_module
            else
                log_error "Module $module does not define run_module function."
            fi
        )
    else
        log_error "Module file not found: $module_file"
    fi
done

log_success "Dotfiles setup completed!"