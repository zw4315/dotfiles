#!/bin/bash
set -e

### === 1. è®¾å®š dotfiles è·¯å¾„ === ###
if [ -z "$1" ]; then
    if [ -z "${BASH_SOURCE[0]}" ]; then
        DOTFILES="$HOME/.dotfiles"
    else
        SCRIPT_PATH="${BASH_SOURCE[0]}"
        while [ -h "$SCRIPT_PATH" ]; do
            SCRIPT_PATH=$(readlink "$SCRIPT_PATH")
        done
        cd "$(dirname "$SCRIPT_PATH")"
        DOTFILES=$(pwd)
    fi
else
    DOTFILES="$1"
fi

echo "ğŸ‘‰ Installing dotfiles from: $DOTFILES"

### === 2. åˆ›å»ºè½¯é“¾æ¥å‡½æ•° === ###
link() {
    NAME="$1"
    TARGET="$HOME/.$NAME"
    SOURCE="$DOTFILES/files/$NAME"

    if [ ! -f "$SOURCE" ]; then
        echo "âŒ $SOURCE does not exist. Skipping."
        return
    fi

    if [ -h "$TARGET" ]; then
        if [ "$(readlink "$TARGET")" != "$SOURCE" ]; then
            mv "$TARGET" "$TARGET.old"
            echo "ğŸ” Existing symlink replaced and backed up: $TARGET -> $TARGET.old"
        else
            echo "âœ… $TARGET already linked. Skipping."
            return
        fi
    elif [ -e "$TARGET" ]; then
        mv "$TARGET" "$TARGET.old"
        echo "ğŸ“¦ Existing file backed up: $TARGET -> $TARGET.old"
    fi

    ln -s "$SOURCE" "$TARGET"
    echo "ğŸ”— Linked $TARGET -> $SOURCE"
}

### === 3. éå† files ç›®å½• === ###
linkall() {
    for f in "$DOTFILES"/files/*; do
        link "$(basename "$f")"
    done
    echo "âœ… All dotfiles linked."
}

### === 4. å®‰è£… vim-plug æ’ä»¶ç®¡ç†å™¨ === ###
install_vim_plug() {
    if [ ! -f ~/.vim/autoload/plug.vim ]; then
        echo "â¬‡ï¸ Installing vim-plug..."
        curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
             https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    else
        echo "âœ… vim-plug already installed."
    fi
}

### === 5. å®‰è£…æ’ä»¶ === ###
install_plugins() {
    echo "ğŸ”§ Installing Vim plugins..."
    vim +PlugInstall +qall
}

### === 6. æ‰§è¡Œæµç¨‹ === ###
linkall
install_vim_plug
install_plugins

echo "ğŸ‰ Setup complete!"

