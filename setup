#!/bin/bash
set -euo pipefail

# 1. æ£€æµ‹ dotfiles ç›®å½•
DOTFILES="${DOTFILES:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
echo "Installing dotfiles from: $DOTFILES"

# 2. é“¾æ¥ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•ï¼ˆå®‰å…¨æ¨¡å¼ï¼šä¸è¦†ç›–å·²æœ‰éè½¯é“¾ï¼‰
link_one() {
    local src="$1"
    local dst="$2"

    # å¦‚æœå·²ç»æ˜¯æ­£ç¡®çš„è½¯é“¾ï¼Œè·³è¿‡
    if [[ -L "$dst" && "$(readlink "$dst")" == "$src" ]]; then
        echo "âœ… $dst already linked"
        return
    fi

    # å¦‚æœç›®æ ‡å­˜åœ¨ä¸”ä¸æ˜¯è½¯é“¾ï¼Œå¤‡ä»½
    if [[ -e "$dst" && ! -L "$dst" ]]; then
        mv "$dst" "$dst.backup.$(date +%s)"
        echo "ğŸ’¾ Backup $dst"
    fi

    ln -sfn "$src" "$dst"
    echo "ğŸ”— Linked $dst â†’ $src"
}

# 3. é“¾æ¥æ‰€æœ‰ dotfilesï¼ˆä¿æŒç»“æ„ï¼‰
link_all() {
    for path in "$DOTFILES/files"/*; do
        local name
        name="$(basename "$path")"

        if [[ "$name" == "vim" ]]; then
            # Vim ç‰¹æ®Šå¤„ç†ï¼šåªæ‹†åˆ†å­ç›®å½•é“¾æ¥ï¼Œä¿ç•™æœ¬åœ°çš„ ~/.vim/plugged
            link_vim_preserve_plugins "$path" "$HOME/.vim"
        elif [[ "$name" == "nvim" ]]; then
            mkdir -p "$HOME/.config"
            link_one "$path" "$HOME/.config/nvim"
        else
            link_one "$path" "$HOME/.$name"
        fi
    done
}

# 4. ä¿ç•™ ~/.vim/pluginï¼Œåªè½¯é“¾å…¶ä»–å†…å®¹
link_vim_preserve_plugins() {
    local src_root="$1"
    local dst_root="$2"

    mkdir -p "$dst_root"

    for sub in "$src_root"/*; do
        local base
        base="$(basename "$sub")"

        # æ³¨æ„ï¼š~/.vim/plugged *ä¸* åœ¨ $src_root é‡Œï¼Œæ‰€ä»¥ä¸ä¼šè¢«åŠ¨åˆ°
        link_one "$sub" "$dst_root/$base"
    done
}

install_yank() {
  local dst="$DOTFILES/scripts/yank"
  local url="https://raw.githubusercontent.com/sunaku/home/master/bin/yank"

  # å·²å­˜åœ¨å°±è·³è¿‡ï¼ˆä½ ä¹Ÿå¯ä»¥æ”¹æˆæ¯æ¬¡éƒ½æ›´æ–°ï¼‰
  if [[ -f "$dst" ]]; then
    echo "âœ… yank already exists at: $dst"
  else
    echo "â¬‡ï¸  Downloading yank -> $dst"
    mkdir -p "$(dirname "$dst")"

    if command -v curl >/dev/null 2>&1; then
      curl -fsSL "$url" -o "$dst"
    elif command -v wget >/dev/null 2>&1; then
      wget -qO "$dst" "$url"
    else
      echo "âŒ Need curl or wget to download yank" >&2
      exit 1
    fi

    chmod +x "$dst"
    echo "âœ… yank installed: $dst"
  fi
}


# é“¾æ¥ scripts ä¸‹çš„å¯æ‰§è¡Œè„šæœ¬åˆ° ~/bin
link_scripts() {
  local scripts_dir="$DOTFILES/scripts"
  local bin_dir="$HOME/bin"

  [[ -d "$scripts_dir" ]] || return 0  # æ²¡æœ‰ scripts ç›®å½•å°±è·³è¿‡

  mkdir -p "$bin_dir"

  for path in "$scripts_dir/"*; do
    [[ -f "$path" ]] || continue
    local name
    name=$(basename "$path")

    # ç”¨ç°æœ‰çš„ link_one é€»è¾‘ï¼ˆä¼šè‡ªåŠ¨å¤‡ä»½å·²æœ‰æ–‡ä»¶ï¼‰
    link_one "$path" "$bin_dir/$name"

    # ç¡®ä¿è„šæœ¬æœ¬èº«æœ‰æ‰§è¡Œæƒé™ï¼ˆè½¯é“¾ç›®æ ‡è¦æœ‰ï¼‰
    chmod +x "$path"
  done

  # æç¤ºä¸€ä¸‹ PATHï¼ˆå¯é€‰ï¼Œä½ çš„ bashrc é‡Œå¯èƒ½å·²ç»åŠ äº†ï¼‰
  if ! echo "$PATH" | grep -q "$HOME/bin"; then
    echo 'âš  æç¤º: è¯·åœ¨ä½ çš„ bashrc ä¸­åŠ å…¥: export PATH="$HOME/bin:$PATH"'
  fi
}

has() { command -v "$1" >/dev/null 2>&1; }
add() { has "$1" || pkgs+=("${2:-$1}"); }

pkgs=()

add fzf
add clang-format
add rg ripgrep
add ctags universal-ctags
add global global
add cscope
add pygmentize python3-pygments
add pipx

# åªæœ‰çœŸçš„éœ€è¦è£…ä¸œè¥¿æ—¶æ‰ updateï¼ˆç¼º apt åŒ… æˆ– ç¼º zoxideï¼‰
if ((${#pkgs[@]})) || ! has zoxide; then
    sudo apt-get update
fi

((${#pkgs[@]})) && sudo apt-get install -y "${pkgs[@]}"

# zoxideï¼šä¼˜å…ˆ aptï¼›apt ä¸å­˜åœ¨/å¤±è´¥æ‰ curlï¼ˆworkaroundï¼‰
if ! has zoxide; then
    sudo apt-get install -y zoxide \
          || curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
fi

link_all
install_yank
link_scripts     # é“¾æ¥ hfget ç­‰è„šæœ¬

echo "âœ… All dotfiles linked."
