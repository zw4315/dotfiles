#!/usr/bin/env bash
# Mihomo ä»£ç†ç®¡ç† alias å’Œå‡½æ•°

# mihomo ä»£ç†
# mih  - å‰å°å¯åŠ¨
# mihd - åå°å®ˆæŠ¤è¿›ç¨‹ç®¡ç†
alias mih='mihomo -f "${HOME}/.config/mihomo/config.yaml"'

# mihd å®ˆæŠ¤è¿›ç¨‹ç®¡ç†å‡½æ•°
mihd() {
  local cmd="${1:-start}"
  local config_file work_dir pid_file log_file

  # é…ç½®æ–‡ä»¶ä½ç½®
  config_file="${HOME}/.config/mihomo/config.yaml"

  # å·¥ä½œç›®å½•æ”¾åœ¨ ~/.local/share/ï¼Œé¿å…æ±¡æŸ“ repo
  work_dir="${HOME}/.local/share/mihomo"
  pid_file="${work_dir}/mihomo.pid"
  log_file="${work_dir}/mihomo.log"
  
  # ç¡®ä¿å·¥ä½œç›®å½•å­˜åœ¨
  mkdir -p "$work_dir"

  # æ—¥å¿—å¤§å°é™åˆ¶ (10MB)
  local max_log_size=$((10 * 1024 * 1024))
  local max_log_lines=1000

  # æ—¥å¿—è½®è½¬å‡½æ•°
  _mihd_rotate_log() {
    if [[ -f "$log_file" ]]; then
      local file_size
      file_size=$(stat -f%z "$log_file" 2>/dev/null || stat -c%s "$log_file" 2>/dev/null || echo 0)
      if [[ "$file_size" -gt "$max_log_size" ]]; then
        tail -n "$max_log_lines" "$log_file" > "${log_file}.tmp" 2>/dev/null && \
          mv "${log_file}.tmp" "$log_file" 2>/dev/null
      fi
    fi
  }

  case "$cmd" in
    start|"")
      if [[ -f "$pid_file" ]] && kill -0 "$(cat "$pid_file")" 2>/dev/null; then
        echo "mihomo is already running (PID: $(cat "$pid_file"))"
        return 1
      fi
      _mihd_rotate_log
      echo "Starting mihomo daemon..."
      nohup mihomo -f "$config_file" -d "$work_dir" >"$log_file" 2>&1 &
      echo $! > "$pid_file"
      echo "mihomo started (PID: $!)"
      echo "Log file: $log_file"
      ;;
    stop|kill)
      if [[ -f "$pid_file" ]]; then
        local pid
        pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
          kill "$pid" 2>/dev/null && echo "mihomo stopped (PID: $pid)"
        fi
        rm -f "$pid_file"
      fi
      # é¢å¤–æ¸…ç†ä»»ä½•æ®‹ç•™çš„è¿›ç¨‹
      local pids
      pids=$(pgrep -x mihomo 2>/dev/null || true)
      if [[ -n "$pids" ]]; then
        echo "$pids" | xargs kill -9 2>/dev/null && echo "mihomo force stopped"
      elif [[ ! -f "$pid_file" ]]; then
        echo "mihomo is not running"
      fi
      ;;
    force|restart)
      # å¼ºåˆ¶é‡å¯ï¼šæ€æ­»æ‰€æœ‰è¿›ç¨‹ + æ¸…ç† pid æ–‡ä»¶ + é‡æ–°å¯åŠ¨
      echo "Force restarting mihomo..."
      # 1. æ€æ­»æ‰€æœ‰ mihomo è¿›ç¨‹
      pkill -9 mihomo 2>/dev/null || true
      # 2. æ¸…ç† pid æ–‡ä»¶
      rm -f "$pid_file"
      # 3. ç­‰å¾…è¿›ç¨‹é€€å‡º
      sleep 1
      # 4. æ—¥å¿—è½®è½¬
      _mihd_rotate_log
      # 5. é‡æ–°å¯åŠ¨
      echo "Starting mihomo daemon..."
      nohup mihomo -f "$config_file" -d "$work_dir" >"$log_file" 2>&1 &
      echo $! > "$pid_file"
      echo "mihomo force restarted (PID: $!)"
      echo "Log file: $log_file"
      ;;
    st|status)
      if [[ -f "$pid_file" ]]; then
        local pid
        pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
          echo "mihomo is running (PID: $pid)"
          echo "Config: $config_file"
          echo "Work dir: $work_dir"
          # æ˜¾ç¤ºç«¯å£ç›‘å¬æƒ…å†µ
          echo "Ports:"
          if command -v ss >/dev/null 2>&1; then
            ss -tln 2>/dev/null | grep -E ":7890|:7891|:9090" | head -3 || echo "  (use 'ss -tln' to check)"
          elif command -v netstat >/dev/null 2>&1; then
            netstat -tln 2>/dev/null | grep -E ":7890|:7891|:9090" | head -3 || echo "  (use 'netstat -tln' to check)"
          else
            echo "  7890 (HTTP/SOCKS5 mixed)"
            echo "  9090 (Web controller)"
          fi
        else
          echo "mihomo is not running (stale PID file: $pid_file)"
        fi
      else
        local pids
        pids=$(pgrep -x mihomo 2>/dev/null || true)
        if [[ -n "$pids" ]]; then
          echo "mihomo is running (PIDs: $pids) - no PID file found"
        else
          echo "mihomo is not running"
        fi
      fi
      ;;
    config|edit)
      # æ‰“å¼€é…ç½®æ–‡ä»¶è¿›è¡Œç¼–è¾‘
      local config_file="${HOME}/.config/mihomo/config.yaml"
      if [[ -f "$config_file" ]]; then
        ${EDITOR:-vim} "$config_file"
      else
        echo "Config not found: $config_file"
        return 1
      fi
      ;;
    logs)
      # æŸ¥çœ‹ mihomo æ—¥å¿—ï¼ˆé»˜è®¤ tail -n 50 -fï¼‰
      local lines="${2:-50}"
      if [[ ! "$lines" =~ ^[0-9]+$ ]]; then
        echo "Invalid lines count: $lines"
        echo "Usage: mihd logs [lines]"
        return 1
      fi

      if [[ -f "$log_file" ]]; then
        echo "Tailing $log_file (last $lines lines, Ctrl+C to exit)"
        tail -n "$lines" -f "$log_file"
      else
        echo "Log file not found: $log_file"
        echo "Start mihomo first with: mihd start"
        return 1
      fi
      ;;
    nodes|ls)
      # åˆ—å‡ºæ‰€æœ‰å¯ç”¨èŠ‚ç‚¹ï¼ˆå¸¦ç¼–å·ï¼ŒæŒ‰å»¶è¿Ÿæ’åºï¼‰
      local api_url="http://127.0.0.1:9090"
      local proxies
      proxies=$(curl -s "$api_url/proxies" 2>/dev/null)
      if [[ -z "$proxies" ]]; then
        echo "Failed to get nodes. Is mihomo running?"
        return 1
      fi
      echo "=== Available Nodes (sorted by delay, use 'mihd use <number>' to switch) ==="
      echo "$proxies" | python3 -c "
import sys, json, re
data = json.load(sys.stdin)

# æ’é™¤çš„ä¿¡æ¯èŠ‚ç‚¹å…³é”®è¯
SKIP_PATTERNS = [
    r'å‰©ä½™æµé‡', r'å¥—é¤åˆ°æœŸ', r'è¿‡æ»¤', r'å¦‚é‡', r'æ¬¢è¿åŠ å…¥',
    r'æ°¸ä¹…åœ°å€', r'å¤§é™†è®¿é—®', r'å®˜æ–¹', r'Telegram', r'@',
    r'V2NY', r'V2NAIUN', r'æ›´æ–°è®¢é˜…', r'ç¾¤ç»„', r'å¤±æ•ˆ'
]

def is_real_node(name):
    '''åˆ¤æ–­æ˜¯å¦æ˜¯çœŸæ­£çš„ä»£ç†èŠ‚ç‚¹ï¼ˆæ’é™¤ä¿¡æ¯/æç¤ºèŠ‚ç‚¹ï¼‰'''
    for pattern in SKIP_PATTERNS:
        if re.search(pattern, name):
            return False
    return True

# æ”¶é›†æ‰€æœ‰çœŸå®èŠ‚ç‚¹
nodes = []
for name, info in data.get('proxies', {}).items():
    if info.get('type') in ['Vmess', 'Vless', 'Shadowsocks', 'Trojan', 'Socks5']:
        if not is_real_node(name):
            continue
        history = info.get('history', [{}])
        delay = history[-1].get('delay', 999999) if history else 999999
        nodes.append((name, delay))

# æŒ‰å»¶è¿Ÿæ’åºï¼ˆä½çš„åœ¨å‰ï¼‰
nodes.sort(key=lambda x: x[1])

# æ‰“å°
for idx, (name, delay) in enumerate(nodes, 1):
    delay_str = f'{delay}ms' if delay < 999999 else 'N/A'
    print(f\"  [{idx:2d}] {name:35s} (delay: {delay_str})\")
" 2>/dev/null || echo "$proxies" | grep -o '"name":"[^"]*"' | head -30
      ;;
    now|current)
      # æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„èŠ‚ç‚¹
      local api_url="http://127.0.0.1:9090"
      curl -s "$api_url/proxies/ğŸš€%20èŠ‚ç‚¹é€‰æ‹©" 2>/dev/null | python3 -c "
import sys, json
data = json.load(sys.stdin)
now = data.get('now', 'N/A')
print(f'Current node: {now}')
print(f\"Use 'mihd nodes' to list all nodes\")
print(f\"Use 'mihd use <number>' to switch\")
" 2>/dev/null || echo "Failed to get current node. Is mihomo running?"
      ;;
    use)
      # åˆ‡æ¢åˆ°æŒ‡å®šèŠ‚ç‚¹ï¼ˆæ”¯æŒæ•°å­—ç´¢å¼•æˆ–åç§°ï¼‰
      # mihd use 0 - åˆ‡æ¢åˆ°è‡ªåŠ¨é€‰æ‹©æ¨¡å¼
      local target="${2:-}"
      if [[ -z "$target" ]]; then
        echo "Usage: mihd use <number|auto>"
        echo "Example: mihd use 1    # ä½¿ç”¨èŠ‚ç‚¹åˆ—è¡¨ä¸­çš„ç¬¬1ä¸ª"
        echo "         mihd use 0    # ä½¿ç”¨è‡ªåŠ¨é€‰æ‹©ï¼ˆæ¨èï¼‰"
        echo "         mihd use auto # åŒä¸Š"
        echo "Use 'mihd nodes' to see the list"
        return 1
      fi
      
      local api_url="http://127.0.0.1:9090"
      local node_name=""
      
      # å¤„ç†è‡ªåŠ¨é€‰æ‹©æ¨¡å¼ (0 æˆ– auto)
      if [[ "$target" == "0" ]] || [[ "$target" == "auto" ]]; then
        # æŸ¥æ‰¾è‡ªåŠ¨é€‰æ‹©ç»„çš„åç§°
        node_name=$(curl -s "$api_url/proxies" 2>/dev/null | python3 -c "
import sys, json
data = json.load(sys.stdin)
# æŸ¥æ‰¾ url-test ç±»å‹çš„ä»£ç†ç»„
for name, info in data.get('proxies', {}).items():
    if info.get('type') == 'url-test':
        print(name)
        break
" 2>/dev/null)
        if [[ -z "$node_name" ]]; then
          echo "âŒ Auto-select group not found"
          return 1
        fi
        echo "ğŸ”„ Switching to auto-select: $node_name"
      # å¦‚æœæ˜¯æ•°å­—ï¼ˆé0ï¼‰ï¼Œè·å–å¯¹åº”èŠ‚ç‚¹åç§°
      elif [[ "$target" =~ ^[0-9]+$ ]]; then
        node_name=$(curl -s "$api_url/proxies" 2>/dev/null | python3 -c "
import sys, json, re
data = json.load(sys.stdin)

# æ’é™¤çš„ä¿¡æ¯èŠ‚ç‚¹å…³é”®è¯ï¼ˆä¸ nodes å‘½ä»¤ä¿æŒä¸€è‡´ï¼‰
SKIP_PATTERNS = [
    r'å‰©ä½™æµé‡', r'å¥—é¤åˆ°æœŸ', r'è¿‡æ»¤', r'å¦‚é‡', r'æ¬¢è¿åŠ å…¥',
    r'æ°¸ä¹…åœ°å€', r'å¤§é™†è®¿é—®', r'å®˜æ–¹', r'Telegram', r'@',
    r'V2NY', r'V2NAIUN', r'æ›´æ–°è®¢é˜…', r'ç¾¤ç»„', r'å¤±æ•ˆ'
]

def is_real_node(name):
    for pattern in SKIP_PATTERNS:
        if re.search(pattern, name):
            return False
    return True

nodes = []
for name, info in data.get('proxies', {}).items():
    if info.get('type') in ['Vmess', 'Vless', 'Shadowsocks', 'Trojan', 'Socks5']:
        if not is_real_node(name):
            continue
        history = info.get('history', [{}])
        delay = history[-1].get('delay', 999999) if history else 999999
        nodes.append((name, delay))

# æŒ‰å»¶è¿Ÿæ’åºï¼ˆä¸ nodes å‘½ä»¤ä¿æŒä¸€è‡´ï¼‰
nodes.sort(key=lambda x: x[1])

idx = int(sys.argv[1]) - 1
if 0 <= idx < len(nodes):
    print(nodes[idx][0])
else:
    print('INVALID_INDEX')
" "$target" 2>/dev/null)
        if [[ "$node_name" == "INVALID_INDEX" ]] || [[ -z "$node_name" ]]; then
          echo "Invalid node number: $target"
          echo "Use 'mihd nodes' to see available nodes"
          return 1
        fi
      else
        node_name="$target"
      fi
      
      # åˆ‡æ¢èŠ‚ç‚¹
      local response
      response=$(curl -s -X PUT "$api_url/proxies/ğŸš€%20èŠ‚ç‚¹é€‰æ‹©" \
        -H "Content-Type: application/json" \
        -d "{\"name\":\"$node_name\"}" 2>/dev/null)
      if [[ $? -eq 0 ]]; then
        echo "Switched to: $node_name"
      else
        echo "Failed to switch node. Is mihomo running?"
        return 1
      fi
      ;;
    *)
      echo "Usage: mihd {start|stop|force|status|logs|config|nodes|now|use}"
      echo "  start        - Start mihomo daemon (default)"
      echo "  stop         - Stop mihomo daemon"
      echo "  force        - Force kill and restart (fix stuck issues)"
      echo "  status       - Check mihomo status"
      echo "  logs         - Tail mihomo logs"
      echo "  config       - Edit config with \$EDITOR (default: vim)"
      echo "  nodes        - List all available nodes"
      echo "  now          - Show current node"
      echo "  use <n|0>    - Switch to node n, or 0/auto for auto-select"
      ;;
  esac
}
