########## å¸¸ç”¨ alias ##########

# é€šç”¨
# enable color support of ls and also add handy aliases
if [ -x /usr/bin/dircolors ]; then
    test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
    alias ls='ls --color=auto'
    #alias dir='dir --color=auto'
    #alias vdir='vdir --color=auto'

    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
fi

# colored GCC warnings and errors
#export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'

# Add an "alert" alias for long running commands.  Use like so:
#   sleep 10; alert
alias alert='notify-send --urgency=low -i "$([ $? = 0 ] && echo terminal || echo error)" "$(history|tail -n1|sed -e '\''s/^\s*[0-9]\+\s*//;s/[;&|]\s*alert$//'\'')"'


alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'

# å®‰å…¨ä¸€ç‚¹ï¼šé˜²æ­¢è¯¯åˆ 
alias rm='rm -i'


# ä»£ç†ç›¸å…³
alias pls='proxy_list'
alias puse='proxy_use'

alias pjump='proxy_use jump'
alias pclash='proxy_use clash'
alias poff='proxy_use off'

########## æŒ‰åŠŸèƒ½åˆ†å— ##########
# å·¥å…·ç±»ï¼ˆç¡®è®¤å‘½ä»¤å­˜åœ¨å† aliasï¼Œé¿å…ä¸åŒæœºå™¨æŠ¥é”™ï¼‰
if command -v rg >/dev/null 2>&1; then
  alias rgi='rg -i'
fi

alias bd='ssh edward@14.103.135.152'
alias bd2='ssh edward@101.126.23.57'
alias yc='ssh -p 43568 edward@38.207.176.66'
alias hd='ssh edward@156.239.24.42'
alias centos='ssh edward@43.129.192.176'
alias llm='ls -lt --reverse'

# tui for task gtd
alias tt="taskwarrior-tui"

# æŸ¥çœ‹å½“å‰ IP å’Œåœ°ç†ä½ç½®
alias whereme='curl -s http://ip-api.com/json'

# mihomo ä»£ç†
# mih  - å‰å°å¯åŠ¨
# mihd - åå°å®ˆæŠ¤è¿›ç¨‹ç®¡ç†
alias mih='mihomo -f "${HOME}/.config/mihomo/config.yaml"'

# mihd å®ˆæŠ¤è¿›ç¨‹ç®¡ç†å‡½æ•°
mihd() {
  local cmd="${1:-start}"
  local config_file work_dir pid_file

  # é…ç½®æ–‡ä»¶ä½ç½®
  config_file="${HOME}/.config/mihomo/config.yaml"

  # å·¥ä½œç›®å½•æ”¾åœ¨ ~/.local/share/ï¼Œé¿å…æ±¡æŸ“ repo
  work_dir="${HOME}/.local/share/mihomo"
  pid_file="${work_dir}/mihomo.pid"
  
  # ç¡®ä¿å·¥ä½œç›®å½•å­˜åœ¨
  mkdir -p "$work_dir"

  case "$cmd" in
    start|"")
      if [[ -f "$pid_file" ]] && kill -0 "$(cat "$pid_file")" 2>/dev/null; then
        echo "mihomo is already running (PID: $(cat "$pid_file"))"
        return 1
      fi
      echo "Starting mihomo daemon..."
      nohup mihomo -f "$config_file" -d "$work_dir" >/dev/null 2>&1 &
      echo $! > "$pid_file"
      echo "mihomo started (PID: $!)"
      ;;
    stop|kill)
      if [[ -f "$pid_file" ]]; then
        local pid
        pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
          kill "$pid" 2>/dev/null && echo "mihomo stopped (PID: $pid)"
        fi
        rm -f "$pid_file"
      fi
      # é¢å¤–æ¸…ç†ä»»ä½•æ®‹ç•™çš„è¿›ç¨‹
      local pids
      pids=$(pgrep -x mihomo 2>/dev/null || true)
      if [[ -n "$pids" ]]; then
        echo "$pids" | xargs kill -9 2>/dev/null && echo "mihomo force stopped"
      elif [[ ! -f "$pid_file" ]]; then
        echo "mihomo is not running"
      fi
      ;;
    force|restart)
      # å¼ºåˆ¶é‡å¯ï¼šæ€æ­»æ‰€æœ‰è¿›ç¨‹ + æ¸…ç† pid æ–‡ä»¶ + é‡æ–°å¯åŠ¨
      echo "Force restarting mihomo..."
      # 1. æ€æ­»æ‰€æœ‰ mihomo è¿›ç¨‹
      pkill -9 mihomo 2>/dev/null || true
      # 2. æ¸…ç† pid æ–‡ä»¶
      rm -f "$pid_file"
      # 3. ç­‰å¾…è¿›ç¨‹é€€å‡º
      sleep 1
      # 4. é‡æ–°å¯åŠ¨
      echo "Starting mihomo daemon..."
      nohup mihomo -f "$config_file" -d "$work_dir" >/dev/null 2>&1 &
      echo $! > "$pid_file"
      echo "mihomo force restarted (PID: $!)"
      ;;
    st|status)
      if [[ -f "$pid_file" ]]; then
        local pid
        pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
          echo "mihomo is running (PID: $pid)"
          echo "Config: $config_file"
          echo "Work dir: $work_dir"
          # æ˜¾ç¤ºç«¯å£ç›‘å¬æƒ…å†µ
          echo "Ports:"
          if command -v ss >/dev/null 2>&1; then
            ss -tln 2>/dev/null | grep -E ":7890|:7891|:9090" | head -3 || echo "  (use 'ss -tln' to check)"
          elif command -v netstat >/dev/null 2>&1; then
            netstat -tln 2>/dev/null | grep -E ":7890|:7891|:9090" | head -3 || echo "  (use 'netstat -tln' to check)"
          else
            echo "  7890 (HTTP/SOCKS5 mixed)"
            echo "  9090 (Web controller)"
          fi
        else
          echo "mihomo is not running (stale PID file: $pid_file)"
        fi
      else
        local pids
        pids=$(pgrep -x mihomo 2>/dev/null || true)
        if [[ -n "$pids" ]]; then
          echo "mihomo is running (PIDs: $pids) - no PID file found"
        else
          echo "mihomo is not running"
        fi
      fi
      ;;
    config|edit)
      # æ‰“å¼€é…ç½®æ–‡ä»¶è¿›è¡Œç¼–è¾‘
      local config_file="${HOME}/.config/mihomo/config.yaml"
      if [[ -f "$config_file" ]]; then
        ${EDITOR:-vim} "$config_file"
      else
        echo "Config not found: $config_file"
        return 1
      fi
      ;;
    nodes|ls)
      # åˆ—å‡ºæ‰€æœ‰å¯ç”¨èŠ‚ç‚¹ï¼ˆå¸¦ç¼–å·ï¼ŒæŒ‰å»¶è¿Ÿæ’åºï¼‰
      local api_url="http://127.0.0.1:9090"
      local proxies
      proxies=$(curl -s "$api_url/proxies" 2>/dev/null)
      if [[ -z "$proxies" ]]; then
        echo "Failed to get nodes. Is mihomo running?"
        return 1
      fi
      echo "=== Available Nodes (sorted by delay, use 'mihd use <number>' to switch) ==="
      echo "$proxies" | python3 -c "
import sys, json, re
data = json.load(sys.stdin)

# æ’é™¤çš„ä¿¡æ¯èŠ‚ç‚¹å…³é”®è¯
SKIP_PATTERNS = [
    r'å‰©ä½™æµé‡', r'å¥—é¤åˆ°æœŸ', r'è¿‡æ»¤', r'å¦‚é‡', r'æ¬¢è¿åŠ å…¥',
    r'æ°¸ä¹…åœ°å€', r'å¤§é™†è®¿é—®', r'å®˜æ–¹', r'Telegram', r'@',
    r'V2NY', r'V2NAIUN', r'æ›´æ–°è®¢é˜…', r'ç¾¤ç»„', r'å¤±æ•ˆ'
]

def is_real_node(name):
    '''åˆ¤æ–­æ˜¯å¦æ˜¯çœŸæ­£çš„ä»£ç†èŠ‚ç‚¹ï¼ˆæ’é™¤ä¿¡æ¯/æç¤ºèŠ‚ç‚¹ï¼‰'''
    for pattern in SKIP_PATTERNS:
        if re.search(pattern, name):
            return False
    return True

# æ”¶é›†æ‰€æœ‰çœŸå®èŠ‚ç‚¹
nodes = []
for name, info in data.get('proxies', {}).items():
    if info.get('type') in ['Vmess', 'Vless', 'Shadowsocks', 'Trojan', 'Socks5']:
        if not is_real_node(name):
            continue
        history = info.get('history', [{}])
        delay = history[-1].get('delay', 999999) if history else 999999
        nodes.append((name, delay))

# æŒ‰å»¶è¿Ÿæ’åºï¼ˆä½çš„åœ¨å‰ï¼‰
nodes.sort(key=lambda x: x[1])

# æ‰“å°
for idx, (name, delay) in enumerate(nodes, 1):
    delay_str = f'{delay}ms' if delay < 999999 else 'N/A'
    print(f\"  [{idx:2d}] {name:35s} (delay: {delay_str})\")
" 2>/dev/null || echo "$proxies" | grep -o '"name":"[^"]*"' | head -30
      ;;
    now|current)
      # æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„èŠ‚ç‚¹
      local api_url="http://127.0.0.1:9090"
      curl -s "$api_url/proxies/ğŸš€%20èŠ‚ç‚¹é€‰æ‹©" 2>/dev/null | python3 -c "
import sys, json
data = json.load(sys.stdin)
now = data.get('now', 'N/A')
print(f'Current node: {now}')
print(f\"Use 'mihd nodes' to list all nodes\")
print(f\"Use 'mihd use <number>' to switch\")
" 2>/dev/null || echo "Failed to get current node. Is mihomo running?"
      ;;
    use)
      # åˆ‡æ¢åˆ°æŒ‡å®šèŠ‚ç‚¹ï¼ˆæ”¯æŒæ•°å­—ç´¢å¼•æˆ–åç§°ï¼‰
      local target="${2:-}"
      if [[ -z "$target" ]]; then
        echo "Usage: mihd use <number>"
        echo "Example: mihd use 1"
        echo "Use 'mihd nodes' to see the list"
        return 1
      fi
      
      local api_url="http://127.0.0.1:9090"
      local node_name=""
      
      # å¦‚æœæ˜¯æ•°å­—ï¼Œè·å–å¯¹åº”èŠ‚ç‚¹åç§°
      if [[ "$target" =~ ^[0-9]+$ ]]; then
        node_name=$(curl -s "$api_url/proxies" 2>/dev/null | python3 -c "
import sys, json, re
data = json.load(sys.stdin)

# æ’é™¤çš„ä¿¡æ¯èŠ‚ç‚¹å…³é”®è¯ï¼ˆä¸ nodes å‘½ä»¤ä¿æŒä¸€è‡´ï¼‰
SKIP_PATTERNS = [
    r'å‰©ä½™æµé‡', r'å¥—é¤åˆ°æœŸ', r'è¿‡æ»¤', r'å¦‚é‡', r'æ¬¢è¿åŠ å…¥',
    r'æ°¸ä¹…åœ°å€', r'å¤§é™†è®¿é—®', r'å®˜æ–¹', r'Telegram', r'@',
    r'V2NY', r'V2NAIUN', r'æ›´æ–°è®¢é˜…', r'ç¾¤ç»„', r'å¤±æ•ˆ'
]

def is_real_node(name):
    for pattern in SKIP_PATTERNS:
        if re.search(pattern, name):
            return False
    return True

nodes = []
for name, info in data.get('proxies', {}).items():
    if info.get('type') in ['Vmess', 'Vless', 'Shadowsocks', 'Trojan', 'Socks5']:
        if not is_real_node(name):
            continue
        history = info.get('history', [{}])
        delay = history[-1].get('delay', 999999) if history else 999999
        nodes.append((name, delay))

# æŒ‰å»¶è¿Ÿæ’åºï¼ˆä¸ nodes å‘½ä»¤ä¿æŒä¸€è‡´ï¼‰
nodes.sort(key=lambda x: x[1])

idx = int(sys.argv[1]) - 1
if 0 <= idx < len(nodes):
    print(nodes[idx][0])
else:
    print('INVALID_INDEX')
" "$target" 2>/dev/null)
        if [[ "$node_name" == "INVALID_INDEX" ]] || [[ -z "$node_name" ]]; then
          echo "Invalid node number: $target"
          echo "Use 'mihd nodes' to see available nodes"
          return 1
        fi
      else
        node_name="$target"
      fi
      
      # åˆ‡æ¢èŠ‚ç‚¹
      local response
      response=$(curl -s -X PUT "$api_url/proxies/ğŸš€%20èŠ‚ç‚¹é€‰æ‹©" \
        -H "Content-Type: application/json" \
        -d "{\"name\":\"$node_name\"}" 2>/dev/null)
      if [[ $? -eq 0 ]]; then
        echo "Switched to: $node_name"
      else
        echo "Failed to switch node. Is mihomo running?"
        return 1
      fi
      ;;
    *)
      echo "Usage: mihd {start|stop|force|status|logs|config|nodes|now|use}"
      echo "  start   - Start mihomo daemon (default)"
      echo "  stop    - Stop mihomo daemon"
      echo "  force   - Force kill and restart (fix stuck issues)"
      echo "  status  - Check mihomo status"
      echo "  logs    - Tail mihomo logs"
      echo "  config  - Edit config with \$EDITOR (default: vim)"
      echo "  nodes   - List all available nodes"
      echo "  now     - Show current node"
      echo "  use     - Switch to a specific node"
      ;;
  esac
}

# æœºå‹/ç¯å¢ƒç›¸å…³ alias å»ºè®®æ”¾åˆ° ~/.bash_aliases.local
[ -f "$HOME/.bash_aliases.local" ] && . "$HOME/.bash_aliases.local"

